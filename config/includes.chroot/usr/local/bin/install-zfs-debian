#!/usr/bin/env bash
#
# install-zfs-debian - Instalador Avan√ßado Aurora (ZFS + Gum)
#

set -euo pipefail

# --- Configura√ß√µes ---
POOL_NAME="zroot"
ZBM_BIN_DIR="/usr/share/zfsbootmenu"
MOUNT_POINT="/mnt/target"
LOG_FILE="/var/log/installer.log"

# Cores e Estilos (Gum)
PRIMARY_COLOR="#00D7FF" # Cyan/Blue Aurora

# --- Helpers ---
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*" >> "$LOG_FILE"
}

error_exit() {
    gum format -- "# ‚ùå Erro Cr√≠tico" "$*"
    log "ERROR: $*"
    cleanup
    exit 1
}

cleanup() {
    log "Iniciando limpeza..."
    sync
    if mountpoint -q "$MOUNT_POINT/boot/efi"; then umount "$MOUNT_POINT/boot/efi"; fi
    
    # Desmontar sistemas virtuais se estiverem montados
    for dir in dev proc sys run; do
        if mountpoint -q "$MOUNT_POINT/$dir"; then umount -l "$MOUNT_POINT/$dir"; fi
    done

    if zpool list "$POOL_NAME" >/dev/null 2>&1;
 then
        zpool export -a || true
    fi
}

trap cleanup ERR SIGINT SIGTERM

# --- Interface TUI ---

welcome_screen() {
    clear
    gum format -- "
# üåå Aurora OS - Instalador ZFS
Bem-vindo ao instalador oficial do **Aurora OS**.
Este assistente ir√° gui√°-lo atrav√©s da instala√ß√£o do Debian com **ZFS-on-Root** e **ZFSBootMenu**.

> *Aviso: Este processo pode ser destrutivo para o disco selecionado.*
"
    gum confirm "Deseja iniciar a instala√ß√£o agora?" || exit 0
}

collect_info() {
    HOSTNAME=$(gum input --placeholder "Hostname do sistema" --value "aurora")
    USERNAME=$(gum input --placeholder "Nome do usu√°rio comum" --value "admin")
    
    gum format -- "### Configura√ß√£o de Seguran√ßa"
    USER_PASS=$(gum input --password --placeholder "Senha para o usu√°rio $USERNAME")
    ROOT_PASS=$(gum input --password --placeholder "Senha para o usu√°rio root")
    
    if [[ -z "$USER_PASS" || -z "$ROOT_PASS" ]]; then
        error_exit "As senhas n√£o podem ser vazias."
    fi
}

select_disk() {
    local disks
    disks=$(lsblk -d -n -o NAME,SIZE,MODEL -e 7,11 | awk '{printf "/dev/%s (%s - %s)\n", $1, $2, substr($0, index($0,$3))}')
    
    if [[ -z "$disks" ]]; then
        error_exit "Nenhum disco detectado."
    fi

    SELECTED_RAW=$(echo "$disks" | gum choose --header "Selecione o disco de destino:")
    DISK_PATH=$(echo "$SELECTED_RAW" | awk '{print $1}')
    
    gum format -- "Voc√™ selecionou: **$DISK_PATH**"
    gum confirm "‚ö†Ô∏è TODOS OS DADOS EM $DISK_PATH SER√ÉO APAGADOS. Confirmar?" || exit 0
}

# --- L√≥gica de Instala√ß√£o ---

prepare_disk() {
    gum spin --spinner dot --title "Limpando e particionando $DISK_PATH..." -- bash -c "
        wipefs -a $DISK_PATH
        sgdisk --zap-all $DISK_PATH
        sgdisk -n 1:2048:+1M -t 1:EF02 -c 1:'BIOS Boot' $DISK_PATH
        sgdisk -n 2:0:+512M -t 2:EF00 -c 2:'EFI System' $DISK_PATH
        sgdisk -n 3:0:0 -t 3:BF00 -c 3:'ZFS Root' $DISK_PATH
        partprobe $DISK_PATH
        sleep 2
    "
}

setup_zfs() {
    local part3
    [[ "$DISK_PATH" =~ [0-9]$ ]] && part3="${DISK_PATH}p3" || part3="${DISK_PATH}3"

    gum spin --spinner dot --title "Criando ZFS Pool e Datasets..." -- bash -c "
        zpool create -f \
            -o ashift=12 \
            -o autotrim=on \
            -O acltype=posixacl -O canmount=off -O compression=zstd \
            -O dnodesize=auto -O normalization=formD -O relatime=on \
            -O xattr=sa -O mountpoint=none \
            $POOL_NAME $part3

        zfs create -o canmount=off -o mountpoint=none $POOL_NAME/ROOT
        zfs create -o canmount=noauto -o mountpoint=/ $POOL_NAME/ROOT/debian
        
        mkdir -p $MOUNT_POINT
        zfs mount $POOL_NAME/ROOT/debian
        
        zfs create -o mountpoint=/home $POOL_NAME/home
        zfs create -o mountpoint=/root $POOL_NAME/home/root
        zfs create -o mountpoint=/var -o canmount=off $POOL_NAME/var
        zfs create $POOL_NAME/var/log
        zfs create $POOL_NAME/var/tmp
    "
}

copy_system() {
    # Usando gum spin para o rsync (poder√≠amos usar progress se calcul√°ssemos o tamanho, mas spin √© mais simples para este contexto)
    gum spin --spinner pulse --title "Sincronizando arquivos do sistema Live (isso pode demorar)..." -- rsync -aAXH \
        --exclude={"/dev/*","/proc/*","/sys/*","/tmp/*","/run/*","/mnt/*","/media/*","/lost+found"} \
        / "$MOUNT_POINT/"
    
    mkdir -p "$MOUNT_POINT"/{dev,proc,sys,tmp,run,mnt,media}
    chmod 1777 "$MOUNT_POINT/tmp"
}

run_in_chroot() {
    local cmd="$1"
    chroot "$MOUNT_POINT" /usr/bin/env bash -c "$cmd"
}

configure_system() {
    gum spin --spinner dot --title "Configurando sistema (Chroot)..." -- bash -c "
        # Montar sistemas virtuais
        mount --bind /dev $MOUNT_POINT/dev
        mount --bind /proc $MOUNT_POINT/proc
        mount --bind /sys $MOUNT_POINT/sys
        mount --bind /run $MOUNT_POINT/run

        # Hostname e Hosts
        echo '$HOSTNAME' > $MOUNT_POINT/etc/hostname
        printf '127.0.0.1\tlocalhost\n127.0.1.1\t%s\n' '$HOSTNAME' > $MOUNT_POINT/etc/hosts

        # Sincronizar hostid
        zgenhostid -f -o $MOUNT_POINT/etc/hostid

        # Usuarios e Senhas
        echo 'root:$ROOT_PASS' | chroot $MOUNT_POINT chpasswd
        chroot $MOUNT_POINT useradd -m -s /bin/bash -G sudo '$USERNAME'
        echo '$USERNAME:$USER_PASS' | chroot $MOUNT_POINT chpasswd

        # Fstab m√≠nimo
        echo '$POOL_NAME/ROOT/debian / zfs defaults 0 0' > $MOUNT_POINT/etc/fstab

        # Gerar initramfs (CR√çTICO para ZFS)
        chroot $MOUNT_POINT update-initramfs -u -k all
    "
}

setup_bootloader() {
    local part2
    [[ "$DISK_PATH" =~ [0-9]$ ]] && part2="${DISK_PATH}p2" || part2="${DISK_PATH}2"

    gum spin --spinner dot --title "Instalando ZFSBootMenu..." -- bash -c "
        mkfs.vfat -F 32 -n 'EFI' $part2
        mkdir -p $MOUNT_POINT/boot/efi
        mount $part2 $MOUNT_POINT/boot/efi
        
        mkdir -p $MOUNT_POINT/boot/efi/EFI/ZBM
        if [[ -d '$ZBM_BIN_DIR' ]]; then
            cp $ZBM_BIN_DIR/*.EFI $MOUNT_POINT/boot/efi/EFI/ZBM/zfsbootmenu.EFI
        fi
        
        if command -v efibootmgr >/dev/null; then
            efibootmgr -c -d $DISK_PATH -p 2 -L 'ZFSBootMenu' -l '\\EFI\\ZBM\\zfsbootmenu.EFI'
        fi
        
        # Configurar linha de comando do kernel no dataset
        zfs set org.zfsbootmenu:commandline='quiet splash' $POOL_NAME/ROOT/debian
    "
}

finalize() {
    gum spin --spinner dot --title "Finalizando e exportando pool..." -- bash -c "
        sync
        umount $MOUNT_POINT/boot/efi
        zpool export $POOL_NAME
    "
    
    gum format -- "
# üéâ Instala√ß√£o Conclu√≠da!
O **Aurora OS** foi instalado com sucesso.

1. Remova a m√≠dia de instala√ß√£o.
2. Reinicie o computador.
"
}

# --- Main ---
main() {
    [[ $EUID -eq 0 ]] || error_exit "Este script precisa ser executado como root."
    
    welcome_screen
    select_disk
    collect_info
    
    prepare_disk
    setup_zfs
    copy_system
    configure_system
    setup_bootloader
    finalize
}

main "$@"