#!/usr/bin/env bash
#
# install-zfs-debian - Instalador Interativo Debian ZFS Root
#
# Realiza o particionamento, criação de pool ZFS e instalação do sistema.
#

set -euo pipefail

# --- Configurações ---
POOL_NAME="zroot"
ZBM_BIN_DIR="/usr/share/zfsbootmenu"
MOUNT_POINT="/mnt/target"

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info() { echo -e "${GREEN}[INFO]${NC} $*"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
error() { echo -e "${RED}[ERROR]${NC} $*" >&2; exit 1; }

check_root() { [[ $EUID -eq 0 ]] || error "Este script precisa ser executado como root."; }

select_disk() {
    info "Discos disponíveis:"
    lsblk -d -n -o NAME,SIZE,MODEL,TYPE | grep "disk"
    echo ""
    read -p "Digite o nome do disco alvo (ex: sda, nvme0n1): " DISK_NAME
    local disk="/dev/$DISK_NAME"
    [[ -b "$disk" ]] || error "Dispositivo inválido: $disk"
    echo "$disk"
}

setup_partitions() {
    local disk="$1"
    warn "LIMPANDO DISCO $disk EM 5 SEGUNDOS..."
    sleep 5
    wipefs -a "$disk"
    sgdisk --zap-all "$disk"
    
    info "Criando partições (Híbrido UEFI/BIOS)..."
    sgdisk -n 1:2048:+1M -t 1:EF02 -c 1:"BIOS Boot" "$disk"
    sgdisk -n 2:0:+512M -t 2:EF00 -c 2:"EFI System" "$disk"
    sgdisk -n 3:0:0 -t 3:BF00 -c 3:"ZFS Root" "$disk"
    partprobe "$disk"
    sleep 2
}

setup_zfs() {
    local disk="$1"
    local part3="${disk}3"
    [[ "$disk" =~ "nvme" ]] && part3="${disk}p3"
    
    info "Criando ZFS Pool '$POOL_NAME' em $part3..."
    zpool create -f \
        -o ashift=12 \
        -O acltype=posixacl -O canmount=off -O compression=zstd \
        -O dnodesize=auto -O normalization=formD -O relatime=on \
        -O xattr=sa -O mountpoint=none \
        "$POOL_NAME" "$part3"

    info "Criando datasets..."
    zfs create -o canmount=off -o mountpoint=none "$POOL_NAME/ROOT"
    zfs create -o canmount=noauto -o mountpoint=/ "$POOL_NAME/ROOT/debian"
    
    mkdir -p "$MOUNT_POINT"
    zfs mount "$POOL_NAME/ROOT/debian"
    
    zfs create -o mountpoint=/home "$POOL_NAME/home"
    zfs create -o mountpoint=/root "$POOL_NAME/home/root"
    zfs create -o mountpoint=/var -o canmount=off "$POOL_NAME/var"
    zfs create "$POOL_NAME/var/log"
    zfs create "$POOL_NAME/var/tmp"
}

copy_system() {
    info "Copiando sistema live para o disco (isso pode demorar)..."
    # Copiamos quase tudo, exceto diretórios dinâmicos
    rsync -aAXHv --progress /
        "$MOUNT_POINT/"
        --exclude={"/dev/*","/proc/*","/sys/*","/tmp/*","/run/*","/mnt/*","/media/*","/lost+found"}
    
    info "Criando diretórios de sistema vazios..."
    mkdir -p "$MOUNT_POINT"/{dev,proc,sys,tmp,run,mnt,media}
    chmod 1777 "$MOUNT_POINT/tmp"
}

setup_bootloader() {
    local disk="$1"
    local part2="${disk}2"
    [[ "$disk" =~ "nvme" ]] && part2="${disk}p2"
    
    info "Configurando ZFSBootMenu..."
    mkfs.vfat -F 32 -n "EFI" "$part2"
    mkdir -p "$MOUNT_POINT/boot/efi"
    mount "$part2" "$MOUNT_POINT/boot/efi"
    
    mkdir -p "$MOUNT_POINT/boot/efi/EFI/ZBM"
    if [[ -d "$ZBM_BIN_DIR" ]]; then
        cp "$ZBM_BIN_DIR"/*.EFI "$MOUNT_POINT/boot/efi/EFI/ZBM/zfsbootmenu.EFI" || warn "ZBM .EFI não encontrado."
    fi
    
    info "Configurando entrada UEFI..."
    efibootmgr -c -d "$disk" -p 2 -L "ZFSBootMenu" -l "\\EFI\\ZBM\\zfsbootmenu.EFI" || warn "Falha ao criar entrada UEFI."
}

finalize() {
    info "Configurando fstab e hostname..."
    echo "$POOL_NAME/ROOT/debian / zfs defaults 0 0" > "$MOUNT_POINT/etc/fstab"
    # Adicionar ESP ao fstab se necessário
    
    info "Limpando e exportando pool..."
    umount "$MOUNT_POINT/boot/efi"
    zpool export "$POOL_NAME"
    info "INSTALAÇÃO CONCLUÍDA! Remova a mídia e reinicie."
}

main() {
    check_root
    local disk
    disk=$(select_disk)
    setup_partitions "$disk"
    setup_zfs "$disk"
    copy_system
    setup_bootloader "$disk"
    finalize
}

main "$@"