#!/bin/bash

# ==============================================================================
# AGENT EXECUTOR - O Kernel do Sistema Cognitivo
# ==============================================================================
# Este script atua como o orquestrador em n√≠vel de SO.
# Ele prepara, roteia e finaliza tarefas, permitindo que o LLM foque apenas
# na intelig√™ncia, n√£o na burocracia.
# ==============================================================================

# Cores e Estilo
BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
NC='\033[0m'

# Caminhos Absolutos (Baseados na raiz do git)
REPO_ROOT="$(git rev-parse --show-toplevel)"
SCRIPTS_DIR="${REPO_ROOT}/.agent/scripts"
BIN_DIR="${REPO_ROOT}/.agent/bin"
LOG_DIR="${REPO_ROOT}/.agent/tmp/logs"

mkdir -p "${LOG_DIR}"

# Fun√ß√£o de Log
log() {
	echo -e "${BLUE}[AGENT-OS]${NC} $1"
	echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >>"${LOG_DIR}/execution.log"
}

error() {
	echo -e "${RED}[ERROR]${NC} $1"
	exit 1
}

# 1. Captura a Inten√ß√£o
QUERY="$*"
if [[ -z ${QUERY} ]]; then
	echo -e "${BOLD}Uso:${NC} agent-exec \"<instru√ß√£o da tarefa>\""
	exit 1
fi

log "Iniciando tarefa: ${BOLD}\"${QUERY}\"${NC}"

# 2. Pr√©-Processamento (Router & Otimiza√ß√£o)
# O Router agora pode retornar c√≥digos de sa√≠da ou strings espec√≠ficas para automa√ß√£o
ROUTER_OUTPUT=$(python3 "${SCRIPTS_DIR}/task_router.py" "${QUERY}" 2>&1)
INTENT=$(echo "${ROUTER_OUTPUT}" | grep "Detected Intent:" | cut -d: -f2 | xargs)

log "Inten√ß√£o Detectada: ${YELLOW}${INTENT}${NC}"

# 3. Fast-Path (Automa√ß√£o sem LLM)
# Se a tarefa for puramente mec√¢nica, execute-a diretamente.
if [[ ${INTENT} == "DEVOPS" ]] && [[ ${QUERY} == *"format"* ]]; then
	log "‚ö° Fast-Path detectado: Formata√ß√£o de c√≥digo."
	trunk fmt --all
	python3 "${SCRIPTS_DIR}/smart_commit.py"
	exit 0
fi

if [[ ${INTENT} == "DEVOPS" ]] && [[ ${QUERY} == *"check"* || ${QUERY} == *"lint"* ]]; then
	log "‚ö° Fast-Path detectado: Verifica√ß√£o de Lint."
	trunk check --all
	exit 0
fi

# 4. Prepara√ß√£o de Contexto para o Agente
# Cria um arquivo de contexto tempor√°rio que o Agente pode ler
CONTEXT_FILE="${REPO_ROOT}/.agent/tmp/current_context.md"
echo "# Contexto da Tarefa Atual" >"${CONTEXT_FILE}"
echo "**Instru√ß√£o:** ${QUERY}" >>"${CONTEXT_FILE}"
echo "**Inten√ß√£o:** ${INTENT}" >>"${CONTEXT_FILE}"
echo "" >>"${CONTEXT_FILE}"
echo "## Output do Router" >>"${CONTEXT_FILE}"
echo "\
$()$(
	" >> "${CONTEXT_FILE}"
echo "${ROUTER_OUTPUT}" >> "${CONTEXT_FILE}"
echo "
)$()" >>"${CONTEXT_FILE}"

log "Contexto preparado em: ${CONTEXT_FILE}"

# 5. Execu√ß√£o (Aqui √© onde a m√°gica acontece)
# Se estiver rodando dentro de um subshell ou chamado por outro agente,
# apenas imprimimos o sinal de pronto.
echo -e "${GREEN}‚úÖ Ambiente Preparado. Execute a tarefa cognitiva agora.${NC}"
echo -e "üí° DICA: Leia o arquivo .agent/tmp/current_context.md para alinhar sua persona."

# Pausa para execu√ß√£o manual ou externa
# Se passado o flag --wait, ele espera o usu√°rio dar Enter.
# Caso contr√°rio, assume que √© parte de um script maior.
if [[ $1 == "--wait" ]]; then
	read -p "Pressione [ENTER] ap√≥s concluir a tarefa cognitiva..."
fi

# 6. P√≥s-Processamento (Smart Commit)
log "Verificando altera√ß√µes para commit..."
python3 "${SCRIPTS_DIR}/smart_commit.py"

log "Ciclo conclu√≠do com sucesso."
